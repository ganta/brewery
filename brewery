#!/usr/bin/ruby

require 'optparse'

BEFORE_COMMANDS = ['update', 'upgrade'].freeze
AFTER_COMMANDS = ['cleanup'].freeze
ignore_commands = []

@options = ARGV.getopts('', 'file:Brewfile', '[no-]update', '[no-]upgrade', '[no-]cleanup')
(BEFORE_COMMANDS + AFTER_COMMANDS).each do |command|
  # The commands that are ignored in Brewfile when explicitly specified.
  ignore_commands << command unless @options[command].nil?
end

system 'ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"' unless system 'type brew'
system 'xcode-select --install' unless Dir.exist?('/usr/include')

brewfile = @options['file']

def exec_brew(command, args = [])
  command_line = "brew #{command} #{args.join(' ')}"
  puts command_line
  system command_line
end

def exec_commands(commands)
  commands.each do |command|
    exec_brew command if @options[command]
  end
end

exec_commands BEFORE_COMMANDS

File.open(brewfile) do |file|
  file.each_line do |line|
    line.strip!
    line.gsub!(/\s*#.*/, '')
    next if line.empty?
    command, *args = line.split(/\s/)
    next if ignore_commands.include?(command)
    exec_brew command, args
  end
end

exec_commands AFTER_COMMANDS
